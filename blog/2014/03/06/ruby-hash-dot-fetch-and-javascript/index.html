
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Ruby Hash#fetch and Javascript - Stephen Aument</title>
	<meta name="author" content="Stephen Aument">

	
	<meta name="description" content="Ruby Hash#fetch and Javascript In a previous post I mentioned a case in which I had a Haml template in a Rails app with Javascript in it. The &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Stephen Aument" type="application/atom+xml">
	
	<link rel="canonical" href="http://stephenaument.github.io/blog/2014/03/06/ruby-hash-dot-fetch-and-javascript/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<img src="http://www.gravatar.com/avatar/c41cd4784eb5610cb99afc1a7c51124d?s=160" alt="Profile Picture" style="width: 160px;" />
	
</div>
<style>
h2.subtitle {
  font-size: 1em;
  font-style: italic;
}

.initial {
  font-size: 1.2em;
}
</style>

<h1><span class='initial'>S</span>tephen <span class='initial'>A</span>ument</h1>
<h2 class='subtitle'>Professional Dilettante</h2>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="http://about.me/stephenaument">About</a></li>
    <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:saument@gmail.com" title="Email">Email</a>
		
		
		
		
			<a class="twitter" href="http://twitter.com/saument" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/stephenaument" title="GitHub">GitHub</a>
		
		
		
		
			<a class="linkedin" href="http://www.linkedin.com/in/stephenaument" title="LinkedIn">LinkedIn</a>
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Ruby Hash#fetch and Javascript</h1>
	<div class="entry-content" itemprop="articleBody"><p>In a <a href="/blog/2014/03/05/the-null-object-pattern-and-method-missing-in-ruby/">previous post</a> I mentioned a case in which I had a Haml template in a Rails app with Javascript in it. The template was rendering Ruby values into what would become a JSON object (Javascript Hash) in the browser. In that particular case, a method call on a Null Object was returning nil and breaking the Javascript.</p>

<p>Well, today I encountered another variation of this problem. In this case, I had a Ruby Hash feeding values into the JSON object. It looked like this:</p>

<div><script src='https://gist.github.com/9403295.js'></script>
<noscript><pre><code>var options = {                                                                                                                                                                                                                                                                           
  &quot;gender&quot;: &quot;#{stored_search_params[&#39;gender&#39;]}&quot;,                                                                                                                                                                                                                                          
  &quot;memberGender&quot;: &quot;#{current_user.short_gender}&quot;,                                                                                                                                                                                                                                         
  &quot;age&quot;: &quot;#{current_user.age}&quot;,                                                                                                                                                                                                                                                           
  &quot;aexcel&quot;: &quot;#{stored_search_params[&#39;aex&#39;]}&quot;,                                                                                                                                                                                                                                             
  &quot;language&quot;: &quot;#{stored_search_params[&#39;language&#39;]}&quot;,                                                                                                                                                                                                                                      
  &quot;displayLanguage&quot;: &quot;#{stored_search_params[&#39;displayLanguage&#39;]}&quot;,                                                                                                                                                                                                                        
  &quot;location&quot;: &quot;#{last_location_searched}&quot;,                                                                                                                                                                                                                                                
  &quot;radius&quot;: &quot;#{stored_search_params[&#39;radius&#39;] || default_search_radius}&quot;,                                                                                                                                                                                                                 
  &quot;query&quot;: &quot;#{stored_search_params[&#39;query&#39;]}&quot;,                                                                                                                                                                                                                                            
  &quot;accepting_new_patients&quot;: &quot;#{stored_search_params[&#39;accepting_new_patients&#39;]}&quot;,                                                                                                                                                                                                          
  &quot;procedure_id&quot;: &quot;#{stored_search_params[&#39;procedure_id&#39;]}&quot;,                                                                                                                                                                                                                              
  &quot;specialty_id&quot;: &quot;#{stored_search_params[&#39;specialty_id&#39;]}&quot;,                                                                                                                                                                                                                              
  &quot;event_properties&quot;: #{stored_search_params.fetch(&#39;event_properties&#39;, {})}                                                                                                                                                                                                               
};      </code></pre></noscript></div>


<p>Two of these fields on the ruby hash are empty: <code>language</code> and <code>properties</code>. Notice that this isn&rsquo;t a problem for most of these fields, but for one it is:</p>

<div><script src='https://gist.github.com/9404094.js'></script>
<noscript><pre><code>var options = {
  &quot;gender&quot;: &quot;M&quot;,
  &quot;age&quot;: &quot;27&quot;,
  &quot;language&quot;: &quot;en-US&quot;,
  &quot;query&quot;: &quot;specials&quot;,
  &quot;properties&quot;: 
};</code></pre></noscript></div>


<p>See that? The first four fields feed into double quotes as strings. If they are empty, they are empty. It may cause an issue somewhere down the line, but the Javascript itself is valid.</p>

<p>The <code>properties</code> field, on the other hand is expecting a JSON object. That missing bit will cause Javascript to blow up once this loads in the browser.</p>

<p>What&rsquo;s the solution here? In this case, I turned to <code>Hash#fetch</code> rather than the <code>[]</code> accessor. What&rsquo;s the difference? There are two main differences between the bracket accessor and the <code>fetch</code> method. First, <code>my_hash[:some_missing_key]</code> will return <code>nil</code> if the key is not found in the hash. If <code>my_hash.fetch(:some_missing_key)</code> can&rsquo;t find a key, it will raise a <code>KeyError</code> exception.</p>

<p>That&rsquo;s not really what we are looking for, which brings me to the second difference. <code>Hash#fetch</code> takes an optional second argument which specifies a default value. So if we call <code>my_hash.fetch(:some_missing_key, 'tacos')</code> and the key is not found in the hash, it will return <code>'tacos'</code> instead of <code>nil</code>. That&rsquo;s exactly what I needed. I returned an empty JSON object <code>{}</code> as the default.</p>

<div><script src='https://gist.github.com/9404014.js'></script>
<noscript><pre><code>var options = {                                                                                                                                                                                                                                                                           
  &quot;gender&quot;: &quot;#{search_params[&#39;gender&#39;]}&quot;,                                                                                                                                                                                                                                          
  &quot;age&quot;: &quot;#{current_user.age}&quot;,                                                                                                                                                                                                                                                           
  &quot;language&quot;: &quot;#{search_params[&#39;language&#39;]}&quot;,                                                                                                                                                                                                                                      
  &quot;query&quot;: &quot;#{search_params[&#39;query&#39;]}&quot;,                                                                                                                                                                                                                                            
  &quot;properties&quot;: #{search_params.fetch(&#39;properties&#39;, {})}                                                                                                                                                                                                               
};</code></pre></noscript></div>


<p>This degraded nicely in the cases in which I had no <code>properties</code> hash in my <code>search_params</code> hash.</p>

<div><script src='https://gist.github.com/9404101.js'></script>
<noscript><pre><code>var options = {
  &quot;gender&quot;: &quot;M&quot;,
  &quot;age&quot;: &quot;27&quot;,
  &quot;language&quot;: &quot;en-US&quot;,
  &quot;query&quot;: &quot;specials&quot;,
  &quot;properties&quot;: {}
};</code></pre></noscript></div>


<p>No more broken Javascript.</p>
</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite">

<script type="text/javascript">
      var disqus_shortname = 'stephenaument';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://stephenaument.github.io/blog/2014/03/06/ruby-hash-dot-fetch-and-javascript/';
        var disqus_url = 'http://stephenaument.github.io/blog/2014/03/06/ruby-hash-dot-fetch-and-javascript/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>

</div>
</section>

</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2014

    Stephen Aument


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
</body>
</html>
